---
name: "dotfiles&docker"

"on":
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3
      matrix:
        ubuntu_version: ["19.10", "20.04", "20.10"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: dotfiles
      - name: Checkout submodules
        run: git submodule update --init --recursive --jobs 4 --depth 1
        working-directory: dotfiles
      - name: Build the Docker image
        working-directory: dotfiles
        run: |
          docker build \
            --build-arg OS_NAME=ubuntu \
            --build-arg OS_VERSION=${{ matrix.ubuntu_version }} \
            --build-arg K_USERNAME=kornicameister \
            --build-arg K_PASSWORD="$(echo "kornicameister" | md5sum)" \
            --build-arg K_EMAIL=kornicameister@dotfiles.git \
            --build-arg K_GPG_FULLNAME="kornicameister gpg" \
            --build-arg K_GPG_PASSPHRASE=${{ github.run_id }} \
            --build-arg K_WAKATIME_API_KEY=${{ github.run_id }} \
            --tag kornicameister/dotfiles:${{ matrix.ubuntu_version }} \
            --compress \
            .
      - name: Upload build.log
        uses: actions/upload-artifact@v1.0.0
        with:
          name: build.log
          path: build.log
