#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

check_submodules() {
    local hasOutdated=0

    git submodule update --init --recursive

    for git_module in $(git submodule status | awk '{print $2}'); do
        cd $PWD/$git_module

        git fetch origin

        if [[ $(git log HEAD..origin/master --oneline | wc -l) -ne 0 ]]; then
            (tput setaf 1 ; echo "$git_module is outdated")
            hasOutdated=1
        fi

        cd - &>/dev/null
    done
    unset git_module

    if [ $hasOutdated -eq 1 ]; then
        exit 1
    fi
}

execute_dotbot() {
    cd "${BASEDIR}"
    git submodule update --init --recursive "${DOTBOT_DIR}"

    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

}

check_submodules
execute_dotbot

