#!/bin/bash

install_system_packages() {
    sudo apt install -yy -qq \
        dconf-cli \
        zsh \
        ccache \
        tree \
        silversearcher-ag
}

install_ctags() {
    # drop unused package
    sudo apt remove exuberant-ctags -qq -yy

    local shouldInstall=0
    if command -v ctags >/dev/null 2>&1; then
        # already installed check if need to reinstall
        cd ./dependencies/ctags
        git fetch origin
        if [[ $(git log HEAD..origin/master --oneline | wc -l) -ne 0 ]]; then
            (tput setaf 1 ; echo "dependencies/ctags is outdated, update the module first")
            exit 1
        else
            shouldInstall=1
        fi
        cd -
    else
        shouldInstall=1
    fi

    if [ $shouldInstall -eq 1 ]; then
        cd ./dependencies/ctags

        ./autogen.sh
        ./configure --prefix=$HOME/.local
        make
        make install

        cd -
    fi
}

check_submodules() {
    local hasOutdated=0

    git submodule update --init --recursive

    for git_module in $(git submodule status | awk '{print $2}'); do
        cd $PWD/$git_module

        git fetch origin

        if [[ $(git log HEAD..origin/master --oneline | wc -l) -ne 0 ]]; then
            (tput setaf 1 ; echo "$git_module is outdated")
            hasOutdated=1
        fi

        cd - &>/dev/null
    done
    unset git_module

    if [ $hasOutdated -eq 1 ]; then
        exit 1
    fi
}

# check if we have newest submodules
check_submodules

# install all necessary system packages
(sudo apt update -qq ; install_system_packages)

# create a target directory of bins coming mainly from my dotfiles
mkdir -p $HOME/.local/bin
